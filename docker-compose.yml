 version: '3.8'
 services:
   timescaledb:
     image: timescale/timescaledb:latest-pg15
     environment:
       POSTGRES_USER: reliability
       POSTGRES_PASSWORD: reliability_password
       POSTGRES_DB: reliability_platform
     ports:
       - "5432:5432"
     volumes:
       - timescale_data:/var/lib/postgresql/data
     healthcheck:
       test: ["CMD-SHELL", "pg_isready -U reliability"]
       interval: 10s
       timeout: 5s
       retries: 5

   zookeeper:
     image: confluentinc/cp-zookeeper:7.5.0
     environment:
       ZOOKEEPER_CLIENT_PORT: 2181
       ZOOKEEPER_TICK_TIME: 2000
     ports:
       - "2181:2181"

   kafka:
     image: confluentinc/cp-kafka:7.5.0
     depends_on:
       - zookeeper
     ports:
       - "9092:9092"
     environment:
       KAFKA_BROKER_ID: 1
       KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
       KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
       KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
       KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
       KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
     healthcheck:
       test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
       interval: 10s
       timeout: 10s
       retries: 5

   redis:
     image: redis:7.2-alpine
     ports:
       - "6379:6379"
     command: redis-server --appendonly yes
     volumes:
       - redis_data:/data
     healthcheck:
       test: ["CMD", "redis-cli", "ping"]
       interval: 10s
       timeout: 5s
       retries: 5

   platform-api:
     build:
       context: ./LLM-REALIABILITY-PLATFORM/platform
       dockerfile: Dockerfile
     depends_on:
       timescaledb:
         condition: service_healthy
       kafka:
         condition: service_healthy
       redis:
         condition: service_healthy
     ports:
       - "8000:8000"
     environment:
       ENVIRONMENT: development
       DATABASE__URL: postgresql+asyncpg://reliability:reliability_password@timescaledb:5432/reliability_platform
       KAFKA__BOOTSTRAP_SERVERS: kafka:29092
       REDIS__URL: redis://redis:6379/0
       OBSERVABILITY__LOG_LEVEL: INFO
     volumes:
       - ./LLM-REALIABILITY-PLATFORM/platform/src:/app/src
     command: uvicorn reliability_platform.main:app --host 0.0.0.0 --port 8000 --reload

 volumes:
   timescale_data:
   redis_data:

